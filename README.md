# DanMacU

Bilibili 直播弹幕姬。

因为之前在 Mac 上用的弹幕库最近几天获取不了弹幕了，所以准备自己写一个。

## 使用

```bash
pipenv install
pipenv shell
python -m danmacu.main <房间号>
```

然后使用浮动窗口工具打开这个程序输出的 URL 即可。

## 工作原理

程序会使用 Bilibili Android 客户端的直播 API，连接 B 站的弹幕 WebSocket 服务器，并启动本地 WebSocket 服务器和 HTTP 服务器。

成功进入房间后，程序会将 B 站 WebSocket 服务器返回的弹幕，送礼等信息发送给连接到本地 WebSocket 服务器的客户端。

而打开终端里的 URL，本地 HTTP 服务输出的页面上的 Javascript 会连接本地 WebSocket 服务器，进而并把弹幕内容显示在页面上。

配合一些全局浮动窗口工具（如 Helium）打开这个本地 HTTP 端口，就可以当一个弹幕姬用了。

见下图：

```text
                          +--------------------------------------------+
                          |                                            |
+-------------------+     |  +------------------+                      |
|                   |     |  |                  |                      |
|  Bilibili Server  +<------>+ WebSocket Client |     Danmacu Core     |
|                   |     |  |                  |                      |
+-------------------+     |  +--------+---------+                      |
                          |           |                                |
                          |  +--------v---------+ +----------------+   |
                          |  |                  | |                |   |
                          |  |     Internal     | |    Internal    |   |
                          |  | Websocket server | |  HTTP Server   |   |
                          |  |                  | |                |   |
                          |  +--------+---------+ +-------+--------+   |
                          |           |                   |            |
                          +--------------------------------------------+
                                      |                   |
                                      |                   |
                                      |        +----------v--------+
                                      |        |  HTML             |
                                      |        |                   |
                                      |        |  +------------+   |
                                      |        |  |     DOM    <-+ |
                                      |        |  +------------+ | |
                                      |        |                 | |
                                      |        |  +------------- | |
                                      +-----------> Javascript +-+ |
                                               |  +------------+   |
                                               |                   |
                                               +-------------------+

                                              Loaded into float window
```

## LICENSE

WTFPL
